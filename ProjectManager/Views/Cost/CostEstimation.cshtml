
@{
    ViewBag.Activity = "成本管理";
    ViewBag.Title = "專案成本估算";
}

@section style{

    <style>

        thead {
            background-color: darkcyan;
            color: white;
            text-align: center;
        }

            thead td {
                cursor: pointer;
            }

            thead a, thead a:hover {
                color: white;
                text-decoration: none;
            }

            thead i {
                float: right;
                height: 24px;
                padding: 4px 0;
            }

    </style>
}

<div class="ml-5">
    <form class="form-inline">
        <div class="form-group mr-3">
            <div class="input-group-prepend">
                <lable class="input-group-text" for="RequiredDeptGUID">需求部門：</lable>
            </div>
            @{
                SelectList Departments = new SelectList(ViewBag.Departments, "DepartmentGUID", "DepartmentName");
            }
            @Html.DropDownList("RequiredDeptGUID", Departments, "請選擇部門", new { @class = "custom-select" })
        </div>
        <div class="form-group">
            <div class="input-group-prepend">
                <lable class="input-group-text" for="Select_ProjectName">專案名稱：</lable>
            </div>
            <select id="Select_ProjectName" class="custom-select"></select>
        </div>
    </form>
</div>


<div id="PartialView" class="mt-3">
</div>

@section asideRight{
    <div class="success-tooltip">
        新增成功
    </div>
    <div class="container text-light mt-3" style="min-width:300px;">
        <form class="needs-validation" id="f_EditResource" novalidate>
            <h4 id="asideTitle" style="display:inline">編輯成本池</h4>
            <button id="btn_reset" type="reset" class="btn btn-danger ml-3">清除重填</button>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">平均薪資：</label>
                    <input id="PoolGUID" name="PoolGUID" style="display:none;" />
                    <div class="row" style="padding-left:12px;">
                        <input id="WagePerHour" name="WagePerHour" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /小時</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">每月租金費用：</label>
                    <div class="row" style="padding-left:12px;">
                        <input id="RentalPerMonth" name="RentalPerMonth" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /月</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">每月水電費用：</label>
                    <div class="row" style="padding-left:12px;">
                        <input id="UtilityPerMonth" name="UtilityPerMonth" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /月</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">其他管理費用：</label>
                    <div class="row" style="padding-left:12px;">
                        <input id="OtherManagementCosts" name="OtherManagementCosts" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /月</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">利息費用：</label>
                    <div class="row" style="padding-left:12px;">
                        <input id="InterestExpense" name="InterestExpense" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /月</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>
            <div class="row col-12 mt-3">
                <div class="form-group mb-0">
                    <label for="ResourceName">風險準備成本：</label>
                    <div class="row" style="padding-left:12px;">
                        <input id="RiskPreparationCost" name="RiskPreparationCost" class="form-control" style="width:10em;" required />
                        <label class="input-group-text ml-3"> /專案</label>
                    </div>
                    <div class="invalid-tooltip">
                        欄位不可為空
                    </div>
                </div>
            </div>

            <div class="row col-12 mt-3">
                <div id="formBtns" class="mt-3 mx-auto text-center">
                    <button id="btn_CancelEdit" type="button" class="btn btn-default py-1 px-3 mr-3">取消</button>
                    <button id="btn_ConfirmAdd" type="button" class="btn btn-primary py-1 px-3 hide">確認新增</button>
                    <button id="btn_ConfirmModify" type="button" class="btn btn-success py-1 px-3">確認修改</button>
                </div>
            </div>
        </form>
    </div>
}

@section script{
    <script>
        $(document).ready(function ()
        {
            $("#ul_costManagement").slideDown();
            $("#li_Charts").addClass("active");

            function LoadProjects()
            {
                var optionlabel = $("<option></option>").text("請選擇專案").val("");
                $("#Select_ProjectName").html(optionlabel);

                if ($("#RequiredDeptGUID").val())
                {
                    $.getJSON("@Url.Action("GetProjectListByDptID", "Cost")", { DepartmentID: $("#RequiredDeptGUID").val() }, function (projects)
                    {
                        var docFrag = $(document.createDocumentFragment());
                        docFrag.append(optionlabel);
                        $.each(projects, function (index, project)
                        {
                            var opt = $("<option></option>").text(project.ProjectName).val(project.ProjectGUID);
                            docFrag.append(opt);
                        });
                        $("#Select_ProjectName").html(docFrag);
                    });
                }
            };

            LoadProjects();

            $("#RequiredDeptGUID").change(() =>
            {
                LoadProjects();
            });

            $("#Select_ProjectName").change(() =>
            {
                LoadSheets();
            });            
            function LoadSheets()
            {
                var DepartmentOpt = $("#RequiredDeptGUID>:selected");
                var departmentGUID = DepartmentOpt.val();
                var projectOpt = $("#Select_ProjectName>:selected");
                var projectGUID = projectOpt.val();
                var PartialView = $("#PartialView");

                var datas =
                {
                    DepartmentID: departmentGUID,
                    ProjectID: projectGUID
                }

                PartialView.load("@Url.Action("GetCostEstimationSheets", "Cost")", datas, function ()
                {

                }).fadeIn();
            }

            LoadStanderPool();
            function LoadStanderPool()
            {
                $.getJSON("@Url.Action("GetStandardPool","Cost")", function (data)
                {
                    $("#PoolGUID").val(data.PoolGUID);
                    $("#WagePerHour").val(data.WagePerHour);
                    $("#RentalPerMonth").val(data.RentalPerMonth);
                    $("#UtilityPerMonth").val(data.UtilityPerMonth);
                    $("#OtherManagementCosts").val(data.OtherManagementCosts);
                    $("#InterestExpense").val(data.InterestExpense);
                    $("#RiskPreparationCost").val(data.RiskPreparationCost);

                })
            }
        })
    </script>
}
